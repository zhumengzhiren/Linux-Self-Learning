# Lecture 5

介绍了网络系统，网络系统可以让我们更方便高效地进行通讯。我们需要的是低延迟，高带宽，有能力识别电脑和错误容忍。

我们要介绍一个概念模型：TCP/IP，它分为四层，高层抽象化低层。

1、数据链路层

功能：实现了网卡接口的网络驱动程序，以处理数据在物理媒介上的传输。

对应设备：网线、网桥、集线器、交换机

常用协议：

（1）ARP(地址解析协议）：它实现IP地址到物理地址（通常是MAC地址，通俗的理解就是网卡地址）的转换。

ARP用途：网络层使用IP地址寻找一台机器，而数据链路层则是使用物理地址寻找一台机器，因此网络层必须先将目标机器的IP地址转化成物理地址，才能使用数据链路层提供的服务。

2、网络层

功能：实现数据包的选路和转发。

对应设备：路由器

常用协议：

（1）IP协议（英特网协议）根据数据包的目的IP地址来决定如何将它发送给目标主机。如果数据包不能直接发送给目标主机，那么IP协议为它寻找一个合适的下一跳路由器，将数据包交给路由器来转发，多次之后数据包将到达目标主机，或者因发送失败而被丢弃。

3、传输层

功能：为两台主机上的应用程序提供端到端的通信。与网络层使用的逐跳通信方式不同，传输层只关心通信的起始端和目的端，而不在乎数据包的中转过程。

主要协议：

（1）TCP协议（传输控制协议）：为应用层提供可靠的、面向连接的和流式服务。

（2）UDP协议（用户数据报协议）：为应用层提供不可靠的、无连接的和数据报服务。

4、应用层

功能：负责处理应用程序的逻辑，比如文件传输，名称查询和网络管理等。

注意：数据链路层、网络层、传输层复制处理网络通信 细节，所以这些部分必须稳定且高效，因此它们都在内核空间实现（如上图二），而应用层在用户空间中实现，因为它负责众多逻辑，在内核中实现的话，则会使内核变得非常庞大。也有少数服务器程序是在内核中实现，这样代码就不用在用户空间和内核空间中来回切换（主要是数据的复制）提高了工作效率。

（1）DNS（域名服务）协议：提供机器域名到IP地址的转换。（如将www.baidu.com转化成百度的IP，输入域名就直接可以进入。因为IP地址记的时候太麻烦，就像每个人都是由身份证唯一标识的，但为了好记就起了名字。DNS就是一个将姓名与身份证对应的过程）

（2）telnet协议是一种远程登陆协议，使我们能在本地完成远程任务。

（3）HTTP协议（超文本传输协议）是一个基于请求与响应模式的、无状态的、应用层的协议，常基于TCP的连接方式。

# Lab 5

#### MAC地址

由于 MAC 地址是唯一的，因此通常称为物理地址。八位字节通常以十六进制书写，并用冒号分隔。MAC 地址示例为 `00:14:22:01:23:45` 。请注意，前 3 个八位字节是指组织唯一标识符 （OUI），它可以帮助识别制造商。

#### IP

IP 地址是用于识别根据 Internet 协议连接到网络的设备的方法。互联网协议有两个版本，IPv4 和 IPv6，它们的地址大小不同。一个示例 IPv6 地址比 `2001:0db8:85a3:0000:0000:8a2e:0370:7334` IPv4 地址长得多，例如 `127.0.0.1` 。

#### ARP

地址解析协议 （ARP） 是一种用于将 IP 地址解析为 MAC 地址的协议。为了理解ARP，我们首先讨论两种发送帧的方法，单播和广播。在第 2 层的上下文中，单播帧意味着将该帧发送到一个 MAC 地址。另一方面，通过将帧发送到广播地址来广播帧意味着该帧应发送到网络上的每个设备，从而有效地寻找本地网络。

#### DNS

DNS 是一种将 google.com 等域名映射到 `172.217.6.78` 的系统。当您查询 google.com 计算机会向 DNS 服务器发送 google.com 的 DNS 查询。假设事情配置正确并且 google.com 有一个有效的相应地址，您将收到来自权威服务器的响应，该响应本质上是“google.com 有IP地址 `x.x.x.x` ”。

#### TCP

TCP 是一种面向流的有状态协议，可确保可靠的传输。可靠的运输从根本上保证了信息完好无损地到达目的地。

TCP 是一种面向连接的协议，这意味着它必须首先建立连接才能发送任何数据。此连接交换信息，即 TCP 用于在其他功能中提供可靠传输的机制。TCP 连接从称为 TCP 握手的东西开始。

TCP 握手包括在发送方和接收方之间交换的数据包的 TCP 标头中设置某些标志。发送方通过首先发送 SYN（设置了 SYN 标志的数据包）来启动 TCP 连接。服务器通过发回 SYN-ACK（一个同时设置了 SYN 和 ACK 标志的数据包）来确认此连接请求。客户端通过将最后一个 ACK 发送回服务器来确认这一点，然后建立连接。

然后，TCP 开始传输数据，如果它成功到达连接的另一端，则发出 ACK。因此，如果数据丢失、重新排序或损坏，TCP 能够识别这一点，并发送重新传输任何丢失数据的请求。

TCP 还具有关闭连接的过程。我们在这里只考虑优雅的终止，突然终止有不同的程序，我们不会赘述。如果您有兴趣，CS168 这里有一些很棒的材料。假设机器 A 想要关闭其与机器 B 的连接。

A 首先发送 FIN，B 必须通过发送 FIN 和 ACK 进行响应。如果 B 只发送 ACK，则连接将保持不变，并且可以发送其他数据，直到发送 FIN 为止。另一方面，B 也可以只发送一个同时设置了 FIN 和 ACK 标志的数据包，即 FIN+ACK，如果 B 准备好关闭连接并且不需要发送额外的数据，一旦 A 收到 FIN 和 ACK，它就会发送最后一个 ACK 以发出连接终止的信号。

#### UDP

UDP 是无状态无连接协议。UDP 专注于在数据报中发送消息。无连接 UDP 也不会产生 TCP 握手和终止的开销。UDP 也不保证可靠的传输，因此消息可能会损坏、无序到达或根本无法到达。因此，UDP 有时被称为不可靠的数据报协议。

虽然 UDP 不保证可靠的传输，但它不会像 TCP 那样受到建立和关闭连接的开销的影响。因此，UDP 非常适合我们只想快速发送数据包的用例，并且丢失其中一些数据包不会造成灾难性后果。

此外，与 TCP 相比，发送的每个 UDP 数据报都需要单独接收。而对于 TCP，您传递的数据流被透明地拆分为一定数量的发送，并且数据流在另一端透明地重建为一个整体。

#### 端口

从广义上讲，端口定义服务终结点 - 端口标记流量入口和出口点。IP 地址连接主机，而端口连接在此类主机上运行的进程。一个端口一次只能绑定一个进程。端口由 16 位数字表示，这意味着范围从 0 到 65535。从 0 到 1023 的端口是众所周知的端口，即系统端口。使用这些端口通常有更严格的要求。1024 到 49151 是注册端口。IANA 维护着知名和注册范围的官方列表。从 49152 到 65535 的其余端口是临时端口，可以根据每个请求为通信会话动态分配。

Some port numbers for well known services are as follows:
一些已知服务的端口号如下：

| Service | Port |
| ------- | ---- |
| SSH     | 22   |
| DNS     | 53   |
| HTTP    | 80   |
| HTTPS   | 443  |

#### Sysadmin Commands

1. `hostname` 一个简单明了的命令，可以显示有关主机、IP 地址、FQDN 等的信息。请务必还签出 `host` ，这是一个类似的命令，通过查找给定名称来提供更详细的信息。

2. `ping` 另一个简单的命令，大多数情况下，您将使用 ping 作为测试连接的第一步。如果 ping 无法到达主机，则可能是连接问题。ping 工具通过向主机发送 ICMP 消息来执行此操作，以期得到响应。

   此外，ping 还提供往返时间 （RTT） 和数据包丢失的指标。往返时间定义为发送 ping 数据包后响应到达所需的时间。这些可以证明是非常有用的统计数据。

3. `traceroute` Traceroute 发送的数据包生存时间 （TTL） 等于跳数。路由器会降低传入数据包的 TTL 值。如果数据包的 TTL = 0，则路由器会丢弃它，并可能将有关路由器身份的诊断信息发回源。否则，路由器将继续转发数据包。

   Traceroute 提供数据包在到达目的地的途中经过的路由器的详细视图。

   如果路由器在超时内没有响应，则 traceroute 会打印星号。

4. `arp` 提供有关系统 ARP 缓存的信息和操作系统缓存的功能。

   使用 arp，您可以显示系统 arp 表。添加、删除或修改 arp 条目等等。

5. `dig` 用于执行 DNS 查询和会审 DNS 问题的实用程序。

   默认情况下，Dig 会对名称服务器执行查询， `/etc/resolv.conf` 但某些选项允许您：指定名称服务器、选择查询类型（迭代与递归）等等——使其成为 `dig` 非常灵活的 DNS 工具。

6. `ip` `ip` 是一个包含许多子命令的命令，提供了很多功能——一开始可能会让人不知所措。您最常使用 ip 来显示/修改路由、IP 地址或网络接口。

   习惯此命令中包含的功能需要时间，但作为参考，这里有一个非常紧凑的备忘单。一些常见的用例包括： `ip addr` 显示 IP 地址信息、 `ip route` 路由表 `ip link` 信息以及网络接口信息。

7. `curl` cURL 顾名思义，允许您查看某些 URL 中的内容。除此之外，它还是一个非常强大的程序，可让您通过几种不同的协议与服务器进行交互和检查，某些协议，例如HTTP，FTP等...

   请务必查看其文档以了解特定用例。 [documentation](https://curl.haxx.se/docs/) 

8. `wget` `wget` 从某种意义上说，它们都是 `curl` 命令行工具，旨在使用某些协议从服务器传输数据或向服务器传输数据，并且都具有许多功能。

   命令之间存在差异，两个值得注意的例子是 wget 只是命令行，这意味着没有库或 API。但是，wget 有一个很大的优势，那就是能够递归下载。

9. `netstat` 此工具适用于打印网络连接、路由表和探测套接字等功能。

   `netstat` 还具有探测套接字的活动并显示协议 （UDP/TCP） 等信息的功能

   如果您正在研究套接字 `ss` ，并且 `lsof` 也是您可能需要考虑的选项

10. `tcpdump` 非常适合监控机器上的传入或传出流量。

    `tcpdump` 在分析流量方面提供了无数选项：它可以捕获数据包、记录流量、计算指标、过滤流量、监控特定接口等。作为入门，您可以查看这些示例。

11. `nc` Netcat 是一个非常强大的工具，几乎可以用于任何涉及 TCP 或 UDP 的事情。它可以打开 TCP 连接、发送 UDP 数据包、侦听任意 TCP 和 UDP 端口、进行端口扫描以及处理 IPv4 和 IPv6。

    ## 问题

### HTTP是否使用TCP或UDP，为什么？

HTTP使用TCP。这是因为HTTP需要确保数据的可靠传输和完整性。TCP提供了可靠的、有序的数据传输，以及错误校验和重传机制，这对于Web页面的完整加载和浏览器与服务器之间的通信是至关重要的。HTTP的特点包括：

1. **可靠传输**：TCP保证数据包的传输是可靠的，即使在网络出现问题时，也会进行重传以确保所有数据包都正确到达。
2. **数据顺序**：TCP确保数据包按顺序到达，而HTTP通常需要按照请求的顺序加载资源（如HTML、CSS、JavaScript、图片等）。
3. **连接控制**：TCP建立连接后会进行流量控制和拥塞控制，确保网络不会过载，这对于网页的稳定加载非常重要。

### Discord和Skype如何，为什么？

Discord和Skype是实时通信应用程序，它们在不同的场景下使用TCP和UDP：

1. **UDP**：对于实时音频和视频流，Discord和Skype主要使用UDP。UDP的低延迟特性使其非常适合实时通信应用，因为它不会等待丢失的数据包重传，这样可以减少延迟，提供更流畅的音视频体验。
2. **TCP**：在需要可靠传输的情况下（如登录认证、消息传递等），它们会使用TCP来确保数据的完整性和顺序。

### 127.0.0.0/8可以包含多少个不同的主机？

127.0.0.0/8网络范围内可以包含2^24 - 2 = 16,777,214个不同的主机地址（去掉网络地址和广播地址）。该范围从127.0.0.1到127.255.255.254。这个范围内的地址被预留用于本地环回地址，用于网络软件开发和本地主机间通信。

### 使用dig命令对google.com执行DNS查找时，可以获得哪三种类型的记录？

使用`dig`命令对google.com执行DNS查找时，常见的三种类型的记录包括：

1. **A记录（IPv4地址）**：返回google.com对应的IPv4地址。
2. **AAAA记录（IPv6地址）**：返回google.com对应的IPv6地址。
3. **MX记录（邮件交换记录）**：显示与google.com相关联的邮件服务器的信息。

### 运行ping的结果是否足以确定是否可以访问服务器？为什么或者为什么不？

运行ping的结果不足以完全确定是否可以访问服务器，原因如下：

1. **防火墙配置**：服务器或网络可能配置了防火墙规则，阻止ICMP（Internet Control Message Protocol）请求（即ping），即使服务器正常运行且服务可访问。
2. **服务状态**：即使ping响应正常，也不能保证特定服务（如HTTP、FTP等）在服务器上运行正常。ping只测试网络层的连通性，而不测试应用层服务的状态。
3. **网络路径**：ping只能测试到达服务器的基本网络路径是否通畅，但不能检测路径中的其他问题，如某些中间路由器的问题。

因此，除了ping外，还需要使用其他工具（如telnet、curl、nc等）来测试特定服务的可达性和响应性。

## 作业

1. shell 脚本 `is_on.sh` ， `is_on.sh host` 以显示是否 `host` 在线。如果是，则显示“确定”。如果不是，则显示“无法访问主机”。
2. shell 脚本 `mac.sh` ，用于处理 `ip` 命令的输出并显示 VM 网络接口 `ens3` 的 MAC 地址。
